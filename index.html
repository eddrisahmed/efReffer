<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ - EF Earn</title>
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #121212; 
            color: #ffffff; 
            margin: 0;
            padding: 0;
        }
        .dark-bg { background-color: #121212; }
        .card-bg { background-color: #1e1e1e; }
        .text-accent { color: #ff8c00; }
        .btn-accent { 
            background-color: #ff8c00; 
            color: #121212; 
            font-weight: bold; 
            transition: all 0.2s ease-in-out; 
        }
        .btn-accent:hover { background-color: #e67e00; }
        .btn-outline-accent { 
            border: 1px solid #ff8c00; 
            color: #ff8c00; 
            transition: all 0.2s ease-in-out; 
        }
        .btn-outline-accent:hover { 
            background-color: #ff8c00; 
            color: #121212; 
        }
        .input-field { 
            background-color: #2c2c2c; 
            border: 1px solid #444; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        
        /* Special Styles for Referral System */
        .referral-code-display {
            background: linear-gradient(45deg, #ff8c00, #ff5500);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.1rem;
            letter-spacing: 1px;
            text-align: center;
            word-break: break-all;
        }
        .stats-card {
            background: linear-gradient(135deg, #1e1e1e, #2d2d2d);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        .bonus-section {
            background: linear-gradient(135deg, #1a237e, #283593);
            border: 1px solid #3949ab;
            border-radius: 12px;
            padding: 16px;
        }
        .used-section {
            background: linear-gradient(135deg, #1b5e20, #2e7d32);
            border: 1px solid #4caf50;
            border-radius: 12px;
            padding: 16px;
        }
        .hidden {
            display: none !important;
        }
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #ff8c00;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen dark-bg">
    <!-- Loader -->
    <div id="loader" class="fixed inset-0 dark-bg bg-opacity-75 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-[#ff8c00]"></div>
        <p class="ml-4 text-[#ff8c00]" id="loader-text">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
    </div>

    <!-- Main Referral Container -->
    <div id="referral-container" class="min-h-screen p-4 max-w-md mx-auto fade-in" style="display: none;">
        <main class="space-y-6">
            <!-- Referral Code Section -->
            <div class="card-bg p-6 rounded-lg text-center">
                <div class="flex items-center justify-center mb-2">
                    <i data-lucide="users" class="w-6 h-6 text-[#ff8c00] mr-2"></i>
                    <p class="text-gray-300 font-semibold">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶á‡¶â‡¶Ü‡¶á‡¶°‡¶ø</p>
                </div>
                
                <div class="referral-code-display flex items-center justify-between mb-4">
                    <span id="referral-code" class="tracking-wider font-mono">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>
                    <button id="copy-code-btn" class="bg-white bg-opacity-20 p-2 rounded-lg hover:bg-opacity-30 transition ml-2">
                        <i data-lucide="copy" class="w-4 h-4"></i>
                    </button>
                </div>
                
                <p class="text-sm text-gray-300 mb-4">
                    ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤‡ßá 
                    <span class="text-[#ff8c00] font-bold" id="referral-bonus-amount">100</span> 
                    ef ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶™‡¶æ‡¶®!
                </p>
                
                <button id="share-btn" class="w-full p-3 rounded-lg btn-accent flex items-center justify-center">
                    <i data-lucide="share-2" class="w-5 h-5 mr-2"></i>
                    ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>

            <!-- Referral Status Section -->
            <div id="referral-status-section">
                <!-- Apply Referral Code Section -->
                <div id="referral-input-section" class="card-bg p-5 rounded-lg">
                    <div class="flex items-center mb-4">
                        <i data-lucide="user-plus" class="w-5 h-5 text-[#ff8c00] mr-2"></i>
                        <h3 class="font-semibold text-lg">‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡ßã‡¶° ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                    </div>
                    
                    <input 
                        id="enter-referral-code" 
                        type="text" 
                        placeholder="‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶á‡¶â‡¶Ü‡¶á‡¶°‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." 
                        class="w-full p-3 rounded-lg input-field mb-3 focus:outline-none focus:ring-2 focus:ring-[#ff8c00]"
                    >
                    
                    <button id="apply-referral-btn" class="w-full p-3 rounded-lg btn-outline-accent flex items-center justify-center">
                        <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>
                        ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                </div>

                <!-- Referrer Info Section (After Applying Code) -->
                <div id="referrer-info-section" class="bonus-section hidden">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 mt-1">
                            <i data-lucide="user-check" class="w-6 h-6 text-blue-400"></i>
                        </div>
                        <div class="ml-3 flex-1">
                            <h3 class="font-bold text-blue-400 text-lg">‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡ßã‡¶° ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</h3>
                            <p class="text-sm text-gray-200 mt-2">
                                ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®: <span id="referrer-name" class="font-medium text-blue-300"></span>
                                <span id="referrer-username" class="text-blue-200 ml-2"></span>
                            </p>
                            <div class="flex space-x-2 mt-3">
                                <button onclick="clearReferralCode()" class="flex-1 p-2 rounded-lg bg-gray-600 text-white text-sm">
                                    ‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
                                </button>
                                <button onclick="claimReferralBonus()" class="flex-1 p-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-semibold text-sm transition">
                                    <i data-lucide="sparkles" class="w-4 h-4 inline mr-1"></i>
                                    <span id="claim-bonus-amount">100</span> ef ‡¶ï‡ßç‡¶≤‡ßá‡¶á‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Already Claimed Section -->
                <div id="referral-used-section" class="used-section hidden">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 mt-1">
                            <i data-lucide="badge-check" class="w-6 h-6 text-green-400"></i>
                        </div>
                        <div class="ml-3 flex-1">
                            <h3 class="font-bold text-green-400 text-lg">‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶™‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®! üéâ</h3>
                            <p class="text-sm text-gray-200 mt-2">
                                ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®: <span id="referrer-info-name" class="font-medium text-green-300"></span>
                                <span id="referrer-info-username" class="text-green-200 ml-2"></span>
                            </p>
                            <p class="text-xs text-gray-300 mt-2 bg-green-900 bg-opacity-30 p-2 rounded">
                                ‡¶Ü‡¶™‡¶®‡¶ø <span class="font-bold" id="claimed-bonus-amount">100</span> ef ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶™‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Referral Statistics -->
            <div class="card-bg p-5 rounded-lg">
                <div class="flex items-center mb-4">
                    <i data-lucide="bar-chart-3" class="w-5 h-5 text-[#ff8c00] mr-2"></i>
                    <h3 class="font-semibold text-lg">‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶ø‡¶∏‡ßç‡¶ü‡¶ø‡¶ï‡ßç‡¶∏</h3>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="stats-card">
                        <div class="text-2xl font-bold text-[#ff8c00]" id="total-referrals">0</div>
                        <div class="text-sm text-gray-400 mt-1">‡¶Æ‡ßã‡¶ü ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤</div>
                    </div>
                    
                    <div class="stats-card">
                        <div class="text-2xl font-bold text-[#ff8c00]" id="referral-earnings">0</div>
                        <div class="text-sm text-gray-400 mt-1">‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶Ü‡¶Ø‡¶º</div>
                    </div>
                </div>

                <div class="mt-4 p-3 bg-gray-800 rounded-lg text-center">
                    <p class="text-sm text-gray-300">
                        ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤‡ßá ‡¶Ü‡¶Ø‡¶º: <span class="text-[#ff8c00] font-bold" id="referrer-bonus-amount">100</span> ef
                    </p>
                </div>
            </div>

            <!-- How It Works -->
            <div class="card-bg p-5 rounded-lg">
                <h3 class="font-semibold text-lg mb-4 flex items-center">
                    <i data-lucide="help-circle" class="w-5 h-5 text-[#ff8c00] mr-2"></i>
                    ‡¶ï‡¶ø‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßá?
                </h3>
                
                <div class="space-y-3">
                    <div class="flex items-start">
                        <div class="bg-[#ff8c00] text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mt-1 flex-shrink-0">1</div>
                        <div class="ml-3">
                            <p class="font-medium">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                            <p class="text-sm text-gray-400">‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡ßá ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <div class="bg-[#ff8c00] text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mt-1 flex-shrink-0">2</div>
                        <div class="ml-3">
                            <p class="font-medium">‡¶¨‡¶®‡ßç‡¶ß‡ßÅ ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                            <p class="text-sm text-gray-400">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <div class="bg-[#ff8c00] text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mt-1 flex-shrink-0">3</div>
                        <div class="ml-3">
                            <p class="font-medium">‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶™‡¶æ‡¶® ‡¶â‡¶≠‡¶Ø‡¶º‡ßá‡¶á</p>
                            <p class="text-sm text-gray-400">‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ ‡¶â‡¶≠‡¶Ø‡¶º‡ßá‡¶á ef ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶™‡¶æ‡¶®</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Alert Modal -->
    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm text-center">
            <p id="alert-message" class="mb-4"></p>
            <button id="alert-ok-btn" class="bg-[#ff8c00] text-gray-900 font-semibold px-6 py-2 rounded-lg">‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá</button>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
  apiKey: "AIzaSyAVsY970aU6sa6Cu2Yw0WnbS3OfCW7QfaY",
  authDomain: "ef-earn-bot.firebaseapp.com",
  databaseURL: "https://ef-earn-bot-default-rtdb.firebaseio.com",
  projectId: "ef-earn-bot",
  storageBucket: "ef-earn-bot.firebasestorage.app",
  messagingSenderId: "700440287970",
  appId: "1:700440287970:web:e602a158b0cc670d3f1cbb"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let currentUser = null;
        let userData = null;
        let appConfig = {};
        const tg = window.Telegram?.WebApp;

        // DOM Elements
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const referralContainer = document.getElementById('referral-container');
        const referralCodeEl = document.getElementById('referral-code');
        const totalReferralsEl = document.getElementById('total-referrals');
        const referralEarningsEl = document.getElementById('referral-earnings');
        const referralInputSection = document.getElementById('referral-input-section');
        const referrerInfoSection = document.getElementById('referrer-info-section');
        const referralUsedSection = document.getElementById('referral-used-section');
        const referralBonusAmountEl = document.getElementById('referral-bonus-amount');
        const referrerBonusAmountEl = document.getElementById('referrer-bonus-amount');
        const claimBonusAmountEl = document.getElementById('claim-bonus-amount');
        const claimedBonusAmountEl = document.getElementById('claimed-bonus-amount');

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Loaded - Starting initialization...');
            initializeApp();
            setupEventListeners();
        });

        // Initialize app with Telegram WebApp
        async function initializeApp() {
            loader.style.display = 'flex';
            loaderText.textContent = '‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
            
            try {
                console.log('Starting app initialization...');
                
                // Check if we're in Telegram WebApp
                if (tg) {
                    console.log('Telegram WebApp detected');
                    tg.expand();
                    tg.enableClosingConfirmation();
                    loaderText.textContent = 'Telegram ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
                } else {
                    console.log('Not in Telegram WebApp environment');
                }
                
                // Get Telegram user data with better error handling
                const tgUser = await getTelegramUser();
                console.log('Telegram User:', tgUser);
                
                if (!tgUser) {
                    // If no Telegram user, use demo mode
                    console.log('No Telegram user found, starting demo mode...');
                    await startDemoMode();
                    return;
                }
                
                loaderText.textContent = '‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
                
                // Set up user data from Telegram
                await setupTelegramUser(tgUser);
                
                loaderText.textContent = '‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
                
                // Load app config
                await loadAppConfig();
                
                // Update UI
                updateReferralUI();
                updateReferralStats();
                updateBonusAmounts();
                
                // Show main content
                referralContainer.style.display = 'block';
                loader.style.display = 'none';
                
                console.log('App initialized successfully');
                
                // Haptic feedback
                if (tg && tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('light');
                }
                
            } catch (error) {
                console.error('Initialization error:', error);
                loaderText.textContent = '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
                
                // Try demo mode as fallback
                try {
                    await startDemoMode();
                } catch (demoError) {
                    console.error('Demo mode also failed:', demoError);
                    showAlert('‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶™‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                    loader.style.display = 'none';
                }
            }
        }

        // Start demo mode for testing
        async function startDemoMode() {
            console.log('Starting demo mode...');
            loaderText.textContent = '‡¶°‡ßá‡¶Æ‡ßã ‡¶Æ‡ßã‡¶° ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
            
            // Create demo user data
            const demoUserId = Math.floor(Math.random() * 1000000000).toString();
            currentUser = {
                uid: demoUserId,
                telegramData: {
                    id: parseInt(demoUserId),
                    first_name: '‡¶°‡ßá‡¶Æ‡ßã ‡¶á‡¶â‡¶ú‡¶æ‡¶∞',
                    username: 'demouser'
                }
            };

            userData = {
                uid: demoUserId,
                telegramData: {
                    first_name: '‡¶°‡ßá‡¶Æ‡ßã ‡¶á‡¶â‡¶ú‡¶æ‡¶∞',
                    username: 'demouser'
                },
                balance: 1500,
                referralCode: demoUserId,
                referredBy: null,
                referralBonusClaimed: false,
                totalReferrals: 3,
                referralEarnings: 300,
                totalEarned: 1800,
                createdAt: new Date()
            };

            appConfig = {
                referralBonus: 100,
                referrerBonus: 100,
                botUsername: "efEarnBot"
            };

            // Update UI
            updateReferralUI();
            updateReferralStats();
            updateBonusAmounts();
            
            // Show main content
            referralContainer.style.display = 'block';
            loader.style.display = 'none';
            
            showAlert('‡¶°‡ßá‡¶Æ‡ßã ‡¶Æ‡ßã‡¶°: ‡¶ü‡ßá‡¶∏‡ßç‡¶ü‡¶ø‡¶Ç ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶§‡ßà‡¶∞‡¶ø ‡¶°‡¶æ‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§');
            console.log('Demo mode started successfully');
        }

        // Get Telegram user data with improved detection
        async function getTelegramUser() {
            console.log('Checking for Telegram user data...');
            
            // Method 1: Check Telegram WebApp
            if (tg && tg.initDataUnsafe) {
                console.log('Telegram initDataUnsafe:', tg.initDataUnsafe);
                
                if (tg.initDataUnsafe.user) {
                    console.log('Found Telegram user:', tg.initDataUnsafe.user);
                    return tg.initDataUnsafe.user;
                }
                
                if (tg.initDataUnsafe.start_param) {
                    console.log('Found start parameter:', tg.initDataUnsafe.start_param);
                }
            }
            
            // Method 2: Check URL parameters for testing
            const urlParams = new URLSearchParams(window.location.search);
            const testUserId = urlParams.get('test_user_id');
            if (testUserId) {
                console.log('Using test user from URL:', testUserId);
                return {
                    id: parseInt(testUserId),
                    first_name: '‡¶ü‡ßá‡¶∏‡ßç‡¶ü ‡¶á‡¶â‡¶ú‡¶æ‡¶∞',
                    username: 'testuser_' + testUserId
                };
            }
            
            // Method 3: Check for Telegram WebApp init data in URL
            const initData = urlParams.get('tgWebAppData');
            if (initData) {
                console.log('Found Telegram WebApp data in URL');
                // In real implementation, you would parse this
            }
            
            console.log('No Telegram user data found');
            return null;
        }

        // Setup Telegram user data with Firebase
        async function setupTelegramUser(tgUser) {
            const userUid = tgUser.id.toString();
            currentUser = {
                uid: userUid,
                telegramData: tgUser
            };

            console.log('Setting up user with UID:', userUid);

            try {
                // Check if user exists in Firestore
                const userDoc = await db.collection("users").doc(userUid).get();
                
                if (userDoc.exists) {
                    // User exists, update profile if needed
                    userData = userDoc.data();
                    console.log('Existing user data loaded:', userData);
                    await updateUserProfileIfNeeded(tgUser, userUid);
                } else {
                    // Create new user
                    console.log('Creating new user in Firebase...');
                    await createNewUser(tgUser, userUid);
                }

                // Load referral data
                await loadReferralData(userUid);
                
            } catch (error) {
                console.error('Error setting up user:', error);
                throw new Error('Firebase error: ' + error.message);
            }
        }

        // Update user profile if Telegram data changed
        async function updateUserProfileIfNeeded(tgUser, userUid) {
            try {
                const needsUpdate = 
                    userData.telegramData?.first_name !== tgUser.first_name ||
                    userData.telegramData?.last_name !== (tgUser.last_name || '') ||
                    userData.telegramData?.username !== (tgUser.username || '') ||
                    userData.telegramData?.photo_url !== (tgUser.photo_url || '');

                if (needsUpdate) {
                    console.log('Updating user profile in Firebase...');
                    await db.collection("users").doc(userUid).update({
                        telegramData: {
                            id: tgUser.id,
                            first_name: tgUser.first_name,
                            last_name: tgUser.last_name || '',
                            username: tgUser.username || '',
                            photo_url: tgUser.photo_url || '',
                            language_code: tgUser.language_code || 'en'
                        },
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Reload user data
                    const updatedDoc = await db.collection("users").doc(userUid).get();
                    userData = updatedDoc.data();
                    console.log('User profile updated:', userData);
                }
            } catch (error) {
                console.error('Error updating user profile:', error);
            }
        }

        // Create new user in Firestore
        async function createNewUser(tgUser, userUid) {
            try {
                // Check if user came from referral (start parameter)
                let referredBy = null;
                if (tg && tg.initDataUnsafe && tg.initDataUnsafe.start_param) {
                    referredBy = tg.initDataUnsafe.start_param;
                    console.log('User referred by:', referredBy);
                }

                const newUserData = {
                    uid: userUid,
                    telegramData: {
                        id: tgUser.id,
                        first_name: tgUser.first_name,
                        last_name: tgUser.last_name || '',
                        username: tgUser.username || '',
                        photo_url: tgUser.photo_url || '',
                        language_code: tgUser.language_code || 'en'
                    },
                    balance: 50, // Starting bonus
                    referralCode: userUid,
                    referredBy: referredBy,
                    referralBonusClaimed: referredBy ? false : null,
                    totalReferrals: 0,
                    referralEarnings: 0,
                    totalEarned: 50,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection("users").doc(userUid).set(newUserData);
                userData = newUserData;
                console.log('New user created in Firebase:', userData);

                // Create referral document
                await db.collection("referrals").doc(userUid).set({
                    userId: userUid,
                    referrerId: referredBy,
                    referredUsers: [],
                    totalReferrals: 0,
                    totalEarnings: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // If user was referred, update referrer's data
                if (referredBy) {
                    await updateReferrerData(referredBy, userUid);
                }
                
            } catch (error) {
                console.error('Error creating new user:', error);
                throw error;
            }
        }

        // Update referrer's data when new user registers
        async function updateReferrerData(referrerUid, newUserUid) {
            try {
                // Update referrer's referral count
                await db.collection("referrals").doc(referrerUid).update({
                    referredUsers: firebase.firestore.FieldValue.arrayUnion(newUserUid),
                    totalReferrals: firebase.firestore.FieldValue.increment(1)
                });
                
                console.log('Referrer data updated for:', referrerUid);
            } catch (error) {
                console.error('Error updating referrer data:', error);
            }
        }

        // Load referral data from Firestore
        async function loadReferralData(userUid) {
            try {
                const referralDoc = await db.collection("referrals").doc(userUid).get();
                if (referralDoc.exists) {
                    userData.referralData = referralDoc.data();
                    console.log('Referral data loaded:', userData.referralData);
                } else {
                    console.log('No referral data found for user');
                }
            } catch (error) {
                console.error('Error loading referral data:', error);
            }
        }

        // Load app configuration from Firebase
        async function loadAppConfig() {
            try {
                const configDoc = await db.collection("config").doc("referral").get();
                if (configDoc.exists) {
                    appConfig = configDoc.data();
                    console.log('App config loaded from Firebase:', appConfig);
                } else {
                    // Create default config if not exists
                    appConfig = {
                        referralBonus: 100,
                        referrerBonus: 100,
                        botUsername: "efEarnBot"
                    };
                    await db.collection("config").doc("referral").set(appConfig);
                    console.log('Default app config created in Firebase');
                }
            } catch (error) {
                console.error('Error loading app config:', error);
                appConfig = {
                    referralBonus: 100,
                    referrerBonus: 100,
                    botUsername: "efEarnBot"
                };
            }
        }

        // Update bonus amounts in UI
        function updateBonusAmounts() {
            const referralBonus = appConfig.referralBonus || 100;
            const referrerBonus = appConfig.referrerBonus || 100;
            
            referralBonusAmountEl.textContent = referralBonus;
            referrerBonusAmountEl.textContent = referrerBonus;
            claimBonusAmountEl.textContent = referralBonus;
            claimedBonusAmountEl.textContent = referralBonus;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Copy referral code
            document.getElementById('copy-code-btn').addEventListener('click', copyReferralCode);
            
            // Share referral link
            document.getElementById('share-btn').addEventListener('click', shareReferralCode);
            
            // Apply referral code
            document.getElementById('apply-referral-btn').addEventListener('click', handleApplyReferralCode);
            
            // Alert OK button
            document.getElementById('alert-ok-btn').addEventListener('click', () => {
                document.getElementById('custom-alert').classList.add('hidden');
            });
        }

        // Update referral UI based on user status
        function updateReferralUI() {
            if (!userData) {
                console.log('No user data available for UI update');
                return;
            }

            console.log('Updating UI with user data:', userData);

            // Update referral code (using Telegram UID)
            referralCodeEl.textContent = userData.uid;
            
            // Show appropriate sections based on referral status
            if (userData.referredBy && userData.referralBonusClaimed) {
                // User has already claimed bonus - PERMANENT STATE
                console.log('Showing already claimed section');
                showReferralUsedSection(userData.referredBy);
                
            } else if (userData.referredBy && userData.referralBonusClaimed === false) {
                // User has applied referral code but not claimed bonus
                console.log('Showing referrer info section');
                showReferrerInfoSection(userData.referredBy);
                
            } else {
                // User hasn't applied any referral code
                console.log('Showing referral input section');
                referralInputSection.classList.remove('hidden');
                referrerInfoSection.classList.add('hidden');
                referralUsedSection.classList.add('hidden');
            }
        }

        // Show referrer info section
        async function showReferrerInfoSection(referrerUid) {
            try {
                console.log('Loading referrer data for:', referrerUid);
                
                // Try to fetch referrer data from Firebase
                const referrerDoc = await db.collection("users").doc(referrerUid).get();
                if (referrerDoc.exists) {
                    const referrerData = referrerDoc.data();
                    
                    document.getElementById('referrer-name').textContent = 
                        referrerData.telegramData?.first_name + 
                        (referrerData.telegramData?.last_name ? ' ' + referrerData.telegramData.last_name : '');
                    
                    document.getElementById('referrer-username').textContent = 
                        referrerData.telegramData?.username ? '@' + referrerData.telegramData.username : '';
                        
                    console.log('Referrer data loaded:', referrerData.telegramData);
                } else {
                    document.getElementById('referrer-name').textContent = '‡¶è‡¶ï‡¶ú‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞';
                    document.getElementById('referrer-username').textContent = '';
                    console.log('Referrer not found in database');
                }
                
                referralInputSection.classList.add('hidden');
                referrerInfoSection.classList.remove('hidden');
                referralUsedSection.classList.add('hidden');
                
            } catch (error) {
                console.error('Error fetching referrer data:', error);
                document.getElementById('referrer-name').textContent = '‡¶è‡¶ï‡¶ú‡¶® ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ';
                document.getElementById('referrer-username').textContent = '';
                
                referralInputSection.classList.add('hidden');
                referrerInfoSection.classList.remove('hidden');
                referralUsedSection.classList.add('hidden');
            }
        }

        // Show referral used section (PERMANENT - cannot be cleared)
        async function showReferralUsedSection(referrerUid) {
            try {
                console.log('Loading referrer data for claimed bonus:', referrerUid);
                
                // Try to fetch referrer data from Firebase
                const referrerDoc = await db.collection("users").doc(referrerUid).get();
                if (referrerDoc.exists) {
                    const referrerData = referrerDoc.data();
                    
                    document.getElementById('referrer-info-name').textContent = 
                        referrerData.telegramData?.first_name + 
                        (referrerData.telegramData?.last_name ? ' ' + referrerData.telegramData.last_name : '');
                    
                    document.getElementById('referrer-info-username').textContent = 
                        referrerData.telegramData?.username ? '@' + referrerData.telegramData.username : '';
                } else {
                    document.getElementById('referrer-info-name').textContent = '‡¶è‡¶ï‡¶ú‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞';
                    document.getElementById('referrer-info-username').textContent = '';
                }
                
                // PERMANENT STATE - hide all other sections
                referralInputSection.classList.add('hidden');
                referrerInfoSection.classList.add('hidden');
                referralUsedSection.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error fetching referrer data:', error);
                document.getElementById('referrer-info-name').textContent = '‡¶è‡¶ï‡¶ú‡¶® ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ';
                document.getElementById('referrer-info-username').textContent = '';
                
                referralInputSection.classList.add('hidden');
                referrerInfoSection.classList.add('hidden');
                referralUsedSection.classList.remove('hidden');
            }
        }

        // Update referral statistics
        async function updateReferralStats() {
            if (!userData) return;

            try {
                // Try to get referral data from Firestore
                const referralDoc = await db.collection("referrals").doc(userData.uid).get();
                if (referralDoc.exists) {
                    const referralData = referralDoc.data();
                    
                    totalReferralsEl.textContent = referralData.totalReferrals || 0;
                    const earnings = (referralData.totalReferrals || 0) * (appConfig.referrerBonus || 100);
                    referralEarningsEl.textContent = earnings;
                } else {
                    // Use user data if Firestore fails
                    totalReferralsEl.textContent = userData.totalReferrals || 0;
                    const earnings = (userData.totalReferrals || 0) * (appConfig.referrerBonus || 100);
                    referralEarningsEl.textContent = earnings;
                }
                
            } catch (error) {
                console.error('Error updating referral stats:', error);
                totalReferralsEl.textContent = userData.totalReferrals || 0;
                const earnings = (userData.totalReferrals || 0) * (appConfig.referrerBonus || 100);
                referralEarningsEl.textContent = earnings;
            }
        }

        // Copy referral code to clipboard
        function copyReferralCode() {
            const textToCopy = userData.uid;
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                showAlert('‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶á‡¶â‡¶Ü‡¶á‡¶°‡¶ø ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
                
                // Haptic feedback
                if (tg && tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('light');
                }
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showAlert('‡¶á‡¶â‡¶Ü‡¶á‡¶°‡¶ø ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
            });
        }

        // Share referral link with Telegram
        function shareReferralCode() {
            const botUsername = appConfig.botUsername || "efEarnBot";
            const referralLink = `https://t.me/${botUsername}?start=${userData.uid}`;
            
            const shareText = `üéâ **EF ‡¶∞‡¶ø‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¨‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶¶‡¶ø‡¶®!**\n\n` +
                            `üí∞ **ef ‡¶â‡¶™‡¶æ‡¶∞‡ßç‡¶ú‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®** ‡¶∏‡¶π‡¶ú ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶ï‡¶∞‡ßá\n` +
                            `üë• **‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶¶‡ßá‡¶∞ ‡¶Ü‡¶Æ‡¶®‡ßç‡¶§‡ßç‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®** ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶â‡¶™‡¶æ‡¶∞‡ßç‡¶ú‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®\n` +
                            `üéÅ **‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶™‡¶æ‡¶®** ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶æ‡¶•‡ßá\n\n` +
                            `üëâ ‡¶è‡¶ñ‡¶®‡¶á ‡¶ú‡¶Ø‡¶º‡ßá‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®: ${referralLink}\n\n` +
                            `#EFEarn #Rewards #TelegramBot`;
            
            if (tg && tg.openTelegramLink) {
                // Use Telegram WebApp method
                const telegramShareUrl = `https://t.me/share/url?url=${encodeURIComponent(referralLink)}&text=${encodeURIComponent(shareText)}`;
                tg.openTelegramLink(telegramShareUrl);
            } else if (navigator.share) {
                // Use Web Share API
                navigator.share({
                    title: 'EF Earn - ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï',
                    text: shareText,
                    url: referralLink
                });
            } else {
                // Fallback - copy to clipboard
                navigator.clipboard.writeText(shareText + '\n' + referralLink).then(() => {
                    showAlert('‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡ßá ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                });
            }
            
            // Haptic feedback
            if (tg && tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }
        }

        // Handle apply referral code
        async function handleApplyReferralCode() {
            const codeInput = document.getElementById('enter-referral-code');
            const code = codeInput.value.trim();
            
            if (!code) {
                return showAlert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶á‡¶â‡¶Ü‡¶á‡¶°‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§');
            }
            
            if (code === userData.uid) {
                return showAlert('‡¶Ü‡¶™‡¶®‡¶ø ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶á‡¶â‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ‡•§');
            }
            
            // Show loading
            const applyBtn = document.getElementById('apply-referral-btn');
            const originalText = applyBtn.innerHTML;
            applyBtn.innerHTML = '<div class="loading-spinner mr-2"></div>‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
            applyBtn.disabled = true;
            
            try {
                // Verify referral UID
                const isValidUID = await verifyReferralUID(code);
                
                if (isValidUID) {
                    // Apply the referral UID
                    await applyReferralCode(code);
                    codeInput.value = '';
                    
                    // Haptic feedback
                    if (tg && tg.HapticFeedback) {
                        tg.HapticFeedback.notificationOccurred('success');
                    }
                    
                } else {
                    showAlert('‡¶Ö‡¶¨‡ßà‡¶ß ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶á‡¶â‡¶Ü‡¶á‡¶°‡¶ø‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶á‡¶â‡¶Ü‡¶á‡¶°‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§');
                    
                    // Haptic feedback for error
                    if (tg && tg.HapticFeedback) {
                        tg.HapticFeedback.notificationOccurred('error');
                    }
                }
                
            } catch (error) {
                console.error('Error applying referral UID:', error);
                showAlert('‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶á‡¶â‡¶Ü‡¶á‡¶°‡¶ø ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
            } finally {
                // Reset button
                applyBtn.innerHTML = originalText;
                applyBtn.disabled = false;
            }
        }

        // Verify referral UID
        async function verifyReferralUID(uid) {
            try {
                // Check if UID exists in users collection
                const userDoc = await db.collection("users").doc(uid).get();
                return userDoc.exists;
            } catch (error) {
                console.error('Error verifying UID:', error);
                return false;
            }
        }

        // Apply referral code to user profile
        async function applyReferralCode(referrerUid) {
            try {
                // Update user data in Firebase
                await db.collection("users").doc(userData.uid).update({
                    referredBy: referrerUid,
                    referralBonusClaimed: false
                });
                
                // Update local user data
                userData.referredBy = referrerUid;
                userData.referralBonusClaimed = false;
                
                // Update UI
                updateReferralUI();
                
                showAlert('‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶á‡¶â‡¶Ü‡¶á‡¶°‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶è‡¶ñ‡¶® ‡¶Ü‡¶™‡¶®‡¶ø ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶ï‡ßç‡¶≤‡ßá‡¶á‡¶Æ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§');
                
            } catch (error) {
                console.error('Error applying referral code:', error);
                showAlert('‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶á‡¶â‡¶Ü‡¶á‡¶°‡¶ø ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
            }
        }

        // Clear referral code (only works if bonus not claimed)
        async function clearReferralCode() {
            if (userData.referralBonusClaimed) {
                return showAlert('‡¶Ü‡¶™‡¶®‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶ï‡ßç‡¶≤‡ßá‡¶á‡¶Æ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡ßã‡¶° ‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§');
            }
            
            try {
                // Update user data in Firebase
                await db.collection("users").doc(userData.uid).update({
                    referredBy: null,
                    referralBonusClaimed: null
                });
                
                // Update local user data
                userData.referredBy = null;
                userData.referralBonusClaimed = null;
                
                // Update UI
                updateReferralUI();
                
                showAlert('‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡ßã‡¶° ‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
                
            } catch (error) {
                console.error('Error clearing referral code:', error);
                showAlert('‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡ßã‡¶° ‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
            }
        }

        // Claim referral bonus (PERMANENT - cannot be undone)
        async function claimReferralBonus() {
            if (!userData.referredBy) {
                return showAlert('‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡ßã‡¶° ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§');
            }
            
            if (userData.referralBonusClaimed) {
                return showAlert('‡¶Ü‡¶™‡¶®‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶ï‡ßç‡¶≤‡ßá‡¶á‡¶Æ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§');
            }
            
            try {
                // Show loading
                showAlert('‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶ï‡ßç‡¶≤‡ßá‡¶á‡¶Æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
                
                const bonusAmount = appConfig.referralBonus || 100;
                const referrerBonusAmount = appConfig.referrerBonus || 100;
                
                // Update user balance and mark as claimed (PERMANENT)
                await db.collection("users").doc(userData.uid).update({
                    balance: firebase.firestore.FieldValue.increment(bonusAmount),
                    totalEarned: firebase.firestore.FieldValue.increment(bonusAmount),
                    referralBonusClaimed: true // PERMANENT - cannot be changed back
                });
                
                // Update referrer's data
                await db.collection("referrals").doc(userData.referredBy).update({
                    totalReferrals: firebase.firestore.FieldValue.increment(1),
                    totalEarnings: firebase.firestore.FieldValue.increment(referrerBonusAmount),
                    referredUsers: firebase.firestore.FieldValue.arrayUnion(userData.uid)
                });
                
                await db.collection("users").doc(userData.referredBy).update({
                    balance: firebase.firestore.FieldValue.increment(referrerBonusAmount),
                    totalEarned: firebase.firestore.FieldValue.increment(referrerBonusAmount)
                });
                
                // Update local user data
                userData.balance += bonusAmount;
                userData.totalEarned += bonusAmount;
                userData.referralBonusClaimed = true; // PERMANENT
                
                // Update UI
                updateReferralUI();
                updateReferralStats();
                
                showAlert(`üéâ ‡¶Ö‡¶≠‡¶ø‡¶®‡¶®‡ßç‡¶¶‡¶®! ‡¶Ü‡¶™‡¶®‡¶ø ${bonusAmount} ef ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶™‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®!`);
                
                // Haptic feedback
                if (tg && tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
                
            } catch (error) {
                console.error('Error claiming referral bonus:', error);
                showAlert('‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶ï‡ßç‡¶≤‡ßá‡¶á‡¶Æ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
            }
        }

        // Show alert message
        function showAlert(message) {
            document.getElementById('alert-message').textContent = message;
            document.getElementById('custom-alert').classList.remove('hidden');
        }

        // Initialize Lucide icons
        lucide.createIcons();
    </script>
</body>
</html>
